name: Build and Deploy BASIC Wasm

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Emscripten
      uses: mymindstorm/setup-emsdk@v14

    - name: Compile to Wasm
      run: |

        # -o を basic.js に変更することで、JSとWasm(内蔵)を生成します
        emcc basic.c runtime.c \
        -o basic.js \
        -I . \
        -O3 \
        -s ALLOW_MEMORY_GROWTH=1 \
        -s EXIT_RUNTIME=1 \
        -s FORCE_FILESYSTEM=0 \
        -s INVOKE_RUN=1 \
        -s SINGLE_FILE=1 \
        -s ASYNCIFY=1

    # 手元に保存したい「JSファイル」をGitHub上にアップロード
    - name: Upload Build for Download
      uses: actions/upload-artifact@v4
      with:
        name: nyan-basic-js-file
        path: basic.js

    # Pages公開用に、最小限の index.html を作成（jsを呼び出すだけ）
    - name: Create index.html for Pages
      run: |
        echo '<!DOCTYPE html><html><head><meta charset="utf-8"></head><body style="background:#000;color:#0f0;"><pre id="out"></pre><script src="basic.js"></script></body></html>' > index.html

    - name: Upload Artifacts for Pages
      uses: actions/upload-pages-artifact@v3
      with:
        path: .

  deploy:
    needs: build
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
    - name: Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4
