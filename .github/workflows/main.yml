name: Build and Deploy BASIC Wasm

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Emscripten
      uses: mymindstorm/setup-emsdk@v14

    - name: Compile to Wasm
      run: |
        # JSとWasmを一体化して出力
        emcc basic.c runtime.c \
        -o basic.js \
        -I . \
        -O3 \
        -s ALLOW_MEMORY_GROWTH=1 \
        -s EXIT_RUNTIME=1 \
        -s FORCE_FILESYSTEM=1 \
        -s INVOKE_RUN=1 \
        -s SINGLE_FILE=1 \
        -s ASYNCIFY=1 \
        -s EXPORTED_RUNTIME_METHODS='["ccall", "cwrap", "FS"]'

    - name: Upload Build for Download
      uses: actions/upload-artifact@v4
      with:
        name: nyan-basic-js-file
        path: basic.js

    - name: Create index.html for Pages
      run: |
        cat << 'EOF' > index.html
        <!DOCTYPE html>
        <html>
        <head>
            <meta charset="utf-8">
            <title>Nyan BASIC Terminal</title>
            <style>
                body { background: #000; color: #0f0; font-family: 'Courier New', monospace; padding: 20px; display: flex; flex-direction: column; height: 95vh; margin: 0; }
                #out { flex-grow: 1; background: #000; color: #0f0; border: 1px solid #333; overflow-y: auto; white-space: pre-wrap; padding: 10px; font-size: 14px; line-height: 1.2; }
                #in { background: #111; color: #fff; border: 1px solid #333; padding: 12px; font-family: monospace; font-size: 14px; outline: none; margin-top: 5px; width: 100%; box-sizing: border-box; }
            </style>
        </head>
        <body>
            <div id="out">--- Nyan BASIC System Loading ---<br></div>
            <input type="text" id="in" autofocus placeholder="Type command here...">
            <script>
                const out = document.getElementById('out');
                const inField = document.getElementById('in');
                let inputQueue = [];

                var Module = {
                    preRun: [function() {
                        // 標準入力のハンドリングを定義
                        Module.stdin = function() {
                            if (inputQueue.length > 0) {
                                return inputQueue.shift();
                            }
                            return null;
                        };
                    }],
                    print: (text) => {
                        out.textContent += text + "\n";
                        out.scrollTop = out.scrollHeight;
                    },
                    printErr: (text) => console.error(text),
                    onRuntimeInitialized: () => {
                        out.textContent += "System Ready.\n";
                    }
                };

                inField.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                        const cmd = inField.value;
                        out.textContent += "> " + cmd + "\n";
                        
                        // 文字列をASCIIコード配列に変換してキューへ（改行コード含む）
                        const chars = (cmd + "\n").split("").map(c => c.charCodeAt(0));
                        inputQueue.push(...chars);
                        
                        inField.value = '';
                    }
                });
            </script>
            <script src="basic.js"></script>
        </body>
        </html>
        EOF

    - name: Upload Artifacts for Pages
      uses: actions/upload-pages-artifact@v3
      with:
        path: .

  deploy:
    needs: build
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
    - name: Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4
